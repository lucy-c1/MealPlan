import { doc, setDoc, collection, addDoc, getDocs } from "firebase/firestore";
import { db } from "../firebase";
import type { Recipe } from "@/types/type";

/**
 * Adds or updates a recipe in a user's "recipes" subcollection in Firestore.
 * This can be either manually created or from the recipe API.
 *
 * - If `recipe.id` is provided, it uses it as the document ID and will overwrite any existing recipe.
 * - If `recipe.id` is not provided, it auto-generates a document ID and saves the recipe under it.
 *
 * @param userId - The unique ID of the user in the "users" collection.
 * @param recipe - The recipe object to store. If no `id` is provided, one will be auto-generated.
 *
 * Firestore Path:
 * - Manual ID: `users/{userId}/recipes/{recipe.id}`
 * - Auto ID:   `users/{userId}/recipes/{autoGeneratedId}`
 */
export async function addRecipe(userId: string, recipe: Recipe) {
  try {
    const recipeData = {
      name: recipe.name,
      area: recipe.area,
      category: recipe.category,
      ingredients: recipe.ingredients,
      instructions: recipe.instructions,
      imageUrl: recipe.imageUrl,
      tags: recipe.tags,
      youtubeUrl: recipe.youtubeUrl ?? null,
    };

    if (recipe.id) {
      const recipeRef = doc(db, "users", userId, "recipes", recipe.id);
      await setDoc(recipeRef, recipeData);
      console.log("Recipe saved with ID:", recipe.id);
    } else {
      const recipesCol = collection(db, "users", userId, "recipes");
      const docRef = await addDoc(recipesCol, recipeData);
      console.log("Recipe saved with auto-generated ID:", docRef.id);
    }
  } catch (error) {
    console.error("Failed to save recipe:", error);
  }
}

/**
 * Fetches all recipes saved by the user from their "recipes" subcollection.
 * 
 * @param userId - The unique ID of the user in the "users" collection.
 * @returns An array of Recipe objects saved by the user.
 */
export async function getUserRecipes(userId: string): Promise<Recipe[]> {
  try {
    const recipesCol = collection(db, "users", userId, "recipes");
    const snapshot = await getDocs(recipesCol);

    const recipes: Recipe[] = [];
    snapshot.forEach((doc) => {
      // Include doc.id if your Recipe type requires it
      recipes.push({ id: doc.id, ...doc.data() } as Recipe);
    });

    return recipes;
  } catch (error) {
    console.error("Failed to fetch user recipes:", error);
    return [];
  }
}

export default {
  addRecipe,
};
